<form style="margin: 0; padding: 0; display: inline">
  <label for="search" style="display: none">Quick Filter:</label>
  <input id="search" name="search" class="quickfilter" type="search" placeholder="Quick Filter" />
</form>

<script type="text/javascript">
  // Cache DOM elements for better performance
  let portalEntries = null;
  let portalGroups = null;
  let noMatchesElement = null;
  
  function initializeSearchCache() {
    portalEntries = Array.from(document.querySelectorAll("div[class='portal-group'] div[class='portal']"));
    portalGroups = Array.from(document.querySelectorAll("div[class='portal-group']"));
    noMatchesElement = document.getElementsByClassName("nomatches")[0];
  }

  function showOnlyMatchedPortals() {
    const query = this.value;

    // Initialize cache if not done yet
    if (!portalEntries) {
      initializeSearchCache();
    }

    if (query.length >= 2) {
      const upperQuery = query.toUpperCase();
      let visibleGroups = 0;
      
      // Use requestAnimationFrame for better performance
      requestAnimationFrame(() => {
        portalEntries.forEach((portalEntry) => {
          // Build searchable string once
          let searchableString = portalEntry.innerText;
          const links = portalEntry.getElementsByTagName("a");
          for (let i = 0; i < links.length; i++) {
            searchableString += "|" + links[i].href;
          }
          
          // Clean up and check match
          searchableString = searchableString
            .replace(/(https|http):\/\//gi, "")
            .replace(/\n/g, "|")
            .toUpperCase();
          
          const isMatch = searchableString.includes(upperQuery);
          
          // Batch DOM updates
          const elements = portalEntry.getElementsByTagName("*");
          for (let i = 0; i < elements.length; i++) {
            elements[i].hidden = !isMatch;
          }
        });
        
        // Update portal groups visibility
        portalGroups.forEach((portalGroup) => {
          const visiblePortals = Array.from(portalGroup.querySelectorAll(".portal *"))
            .filter(elem => !elem.hidden).length;
          
          portalGroup.hidden = visiblePortals === 0;
          if (!portalGroup.hidden) {
            visibleGroups++;
          }
        });
        
        // Show/hide no matches message
        if (noMatchesElement) {
          noMatchesElement.style.display = visibleGroups === 0 ? "block" : "none";
        }
      });
    } else {
      // Show all elements when query is too short
      requestAnimationFrame(() => {
        portalEntries.forEach((portalEntry) => {
          const elements = portalEntry.getElementsByTagName("*");
          for (let i = 0; i < elements.length; i++) {
            elements[i].hidden = false;
          }
        });
        
        portalGroups.forEach((portalGroup) => {
          portalGroup.hidden = false;
        });
        
        if (noMatchesElement) {
          noMatchesElement.style.display = "none";
        }
      });
    }
  }

  function idleSave() {
    var t;

    function saveSearchParamToHistory() {
      const qfInput = document.querySelector("#search");
      writeSearchToHistory.call(qfInput);
    }
    window.onload = resetIdleTimer;
    window.onmousemove = resetIdleTimer;
    window.onmousedown = resetIdleTimer; // catches touchscreen presses as well
    window.ontouchstart = resetIdleTimer; // catches touchscreen swipes as well
    window.onclick = resetIdleTimer; // catches touchpad clicks as well
    window.onkeydown = resetIdleTimer;
    window.addEventListener("scroll", resetIdleTimer, true); // improved; see comments

    function resetIdleTimer() {
      clearTimeout(t);
      t = setTimeout(saveSearchParamToHistory, 5000); // time is in milliseconds
    }
    function writeSearchToHistory() {
      let theURL = new URL(window.location.toString());
      theURL.search = window.location.search.substring(1); // copy current search-parameters without the '#' AS search-parameters
      theURL.searchParams.set("search", this.value);

      if (window.location.toString() !== theURL.href) {
        window.history.replaceState({}, "", theURL.href);
      }
    }
  }
  idleSave();

  window.onload = function () {
    // Select Search Box Element
    const qfInput = document.querySelector("#search");

    // Fill Search Box with URL Search value
    let theURL = new URL("https://dummy.com");
    // create dummy url
    theURL.search = window.location.search.substring(1);
    // copy current search-parameters without the '#' AS search-parameters
    qfInput.value = theURL.searchParams.get("search");

    // Add Event Listeners for changes (After we set the search box value)
    qfInput.addEventListener("change", showOnlyMatchedPortals);
    qfInput.addEventListener("keyup", showOnlyMatchedPortals);
    qfInput.focus({
      preventScroll: true,
    });
    // Place Cursor in the search box, ready to type

    // Create Promise to resolve after initial filtering is done
    var loadScriptAsync = function () {
      return new Promise((resolve, reject) => {
        showOnlyMatchedPortals.call(qfInput);
        resolve();
      });
    };
    var scriptLoaded = loadScriptAsync();
    scriptLoaded.then(function () {
      if (window.location.hash != "") {
        document.querySelectorAll(window.location.hash).forEach(function (anchorLink) {
          if (anchorLink.parentNode.hidden === false) {
            anchorLink.scrollIntoView({
              preventScroll: true,
              behavior: "smooth",
              block: "start",
            });
          }
        });
      }
    });
  };
</script>
